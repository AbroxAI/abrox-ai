<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ASTRONBOT.MAX — Deep Clone (tuned bg + spacing + dropdown add)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --neon-green:#00ff33;
  --neon-green-2:#17d24a;
  --neo-red:#e33b3b;
  --muted:#cbd5e1;
  --glass: rgba(255,255,255,0.04);
  --max-width:1100px;
}

/* reset */
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#000;}
.wrap{ min-height:100vh; display:flex; align-items:center; justify-content:center; padding:18px; }

/* card */
.card{
  width:100%;
  max-width:var(--max-width);
  border-radius:14px;
  overflow:visible;
  position:relative;
  background:linear-gradient(180deg, rgba(1,6,10,0.9), rgba(2,8,12,0.98));
  border:1px solid var(--glass);
  box-shadow:0 18px 60px rgba(0,0,0,0.75);
}

/* header tuned */
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 18px 22px;
  min-height:96px;
  z-index:60;
  position:relative;
  background:linear-gradient(180deg, rgba(2,6,10,0.85), rgba(2,6,10,0.5));
}
.left-header{display:flex; align-items:center; gap:12px; min-width:0;}
.logo-mark{width:46px;height:46px; background:linear-gradient(180deg,var(--neon-green),var(--neon-green-2)); clip-path:polygon(50% 0%,100% 100%,0% 100%); box-shadow:0 0 22px rgba(0,255,51,0.95);}
.brand{display:flex;flex-direction:column;min-width:0;}
.brand-top{display:flex;align-items:center;gap:12px}
.brand-text{
  font-family:Orbitron, sans-serif;
  color:var(--neon-green);
  font-weight:900;
  font-size:40px;
  line-height:40px;
  letter-spacing:1px;
  text-transform:uppercase;
  text-shadow:0 0 10px rgba(0,255,51,0.85),0 12px 36px rgba(0,0,0,0.6);
}
.subtitle{
  font-family:Orbitron, sans-serif;
  font-size:12px;
  color:var(--neon-green-2);
  letter-spacing:2px;
  margin-left:2px;
  font-weight:800;
  text-transform:uppercase;
  text-shadow:0 0 10px rgba(0,255,51,0.18);
}

/* CONTROLS spacing increased */
.controls {
  display:flex;
  gap:24px;             /* increased gap for better balance */
  align-items:center;
  z-index:70;
  position:absolute;
  right:18px;
  top:112px;            /* nudged lower to visually match screenshot */
  pointer-events:auto;
}

.select{
  background:linear-gradient(180deg,#132733,#0e1a28);
  padding:8px 14px;
  border-radius:8px;
  border:1px solid var(--glass);
  min-width:150px;      /* wider chip */
  color:#e8fbff;
  cursor:pointer;
  -webkit-tap-highlight-color: transparent;
  box-shadow: 0 6px 18px rgba(0,0,0,0.5) inset;
}
.select .label{font-size:11px;color:var(--muted); display:block; margin-bottom:2px;}
.select .value{font-weight:800; font-size:14px;}

/* main */
main{position:relative; padding:14px 18px;}
.main-inner{
  position:relative;
  border-radius:12px;
  overflow:hidden;
  background:linear-gradient(180deg, rgba(0,0,0,0.36), rgba(0,0,0,0.45));
  min-height:760px;
}

/* background */
.bg-wrap{ position:absolute; inset:0; z-index:0; overflow:hidden; }
#algoCanvas{ position:absolute; top:0; left:0; width:100%; height:100%; display:block; object-fit:cover; filter: blur(6px) saturate(135%); transform:scale(1.03); }
.bg-overlay{ position:absolute; inset:0; z-index:1; background:linear-gradient(180deg, rgba(24,60,100,0.18), rgba(2,12,24,0.6)); }

/* subtle bokeh */
.bokeh { position:absolute; border-radius:50%; filter: blur(18px) saturate(160%); opacity:0.75; mix-blend-mode:screen; z-index:0; pointer-events:none; }

/* center */
.center{ position:relative; z-index:12; display:flex; align-items:center; flex-direction:column; gap:18px; padding:32px 10px; }

/* triangle area */
.triangle-area{
  width:100%;
  max-width:680px;
  height:460px;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}

/* triangles absolute pixel positions */
.up-tri, .down-tri { position:absolute; left:50%; transform-origin:center; transition: transform .45s cubic-bezier(.22,.98,.33,1), opacity .25s ease; }
.up-tri{ top:112px; transform:translateX(-50%) scale(0.98); z-index:8; }
.up-tri svg{ width:220px; height:220px; display:block; }
.connector { position:absolute; top:248px; left:50%; transform:translate(-50%,-2px); width:240px; height:6px; border-radius:6px; z-index:6; background:linear-gradient(90deg, rgba(0,255,51,0.12), rgba(255,255,255,0.03), rgba(227,59,59,0.06)); box-shadow:0 10px 30px rgba(0,0,0,0.6); }
.down-tri{ top:248px; transform:translateX(-50%) scale(1); z-index:10; }
.down-tri svg{ width:320px; height:320px; display:block; }
.down-glow{ position:absolute; width:92px;height:48px;border-radius:50%; background:radial-gradient(circle at center, rgba(0,255,51,0.98) 0%, rgba(0,255,51,0.28) 25%, rgba(0,0,0,0) 65%); bottom:38px; left:50%; transform:translateX(-50%); filter:blur(6px); z-index:7; }

/* svg text */
svg text{
  font-family:Orbitron, monospace;
  font-weight:900;
  fill:#ffffff;
  paint-order:stroke fill;
  stroke: rgba(0,0,0,0.65);
  stroke-width:2px;
  filter: drop-shadow(0 6px 8px rgba(0,0,0,0.55));
  dominant-baseline:middle;
  letter-spacing:0.6px;
}

/* rec badge */
.rec-badge{
  position:absolute;
  left:22px;
  bottom:26px;
  z-index:14;
  background:linear-gradient(180deg, rgba(3,6,10,0.72), rgba(7,9,12,0.6));
  padding:8px 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.04);
  display:flex;
  gap:8px;
  align-items:center;
}
.rec-badge .rec{ padding:8px 12px; border-radius:8px; font-weight:900; text-transform:uppercase; font-family:Orbitron, sans-serif; color:var(--neon-green); background:transparent; cursor:pointer; transition:transform .12s ease, box-shadow .12s ease; }
.rec-badge .rec.clickable{ background:linear-gradient(180deg,var(--neon-green-2),var(--neon-green)); color:#071012; box-shadow:0 10px 30px rgba(0,255,51,0.18); }
.rec-badge .rec:active{ transform:translateY(1px) }
.rec-badge .small{ font-size:12px; color:var(--muted); }

/* pills (stacking) */
.pills{ margin-top:18px; display:flex; flex-direction:column; gap:14px; align-items:center; z-index:14; }
.pill{ width:240px; padding:12px; border-radius:28px; font-weight:800; font-size:13px; text-transform:uppercase; cursor:pointer; border:1px solid rgba(255,255,255,0.04); box-shadow:0 10px 30px rgba(0,0,0,0.5); text-align:center; }
.pill.green{ background:linear-gradient(180deg,var(--neon-green-2),var(--neon-green)); color:#071012; }
.pill.orange{ background:linear-gradient(180deg,#fbbf24,#f59e0b); color:#071012; width:150px; }

/* modal */
.modal-backdrop{ position:fixed; inset:0; z-index:1200; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); }
.modal{ width:92%; max-width:520px; background:linear-gradient(180deg,#081018,#061016); border-radius:12px; padding:20px; box-shadow:0 24px 80px rgba(0,0,0,0.8); border:1px solid rgba(255,255,255,0.03); color:#eaf6ff; }
.modal h2{ margin:0 0 8px 0; font-family:Orbitron, sans-serif; color:var(--neon-green); letter-spacing:1px; font-size:20px; }
.modal p{ color:var(--muted); margin:0 0 16px 0; line-height:1.35; }
.modal .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
.btn{ padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer; border:0; }
.btn.ghost{ background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.04); }
.btn.primary{ background:linear-gradient(180deg,var(--neon-green-2),var(--neon-green)); color:#071012; }

/* responsive */
@media (max-width:760px){
  .wrap{ padding:0; }
  .card{ border-radius:0; max-width:100%; min-height:100vh; box-shadow:none; }
  header{ padding:14px 14px 58px; }
  .main-inner{ min-height:calc(100vh - 140px); }
  .controls{ right:12px; top:140px; }
  .triangle-area{ height:360px; }
  .up-tri{ top:92px; }
  .down-tri{ top:210px; }
}

/* spinner */
@keyframes spin { to { transform: rotate(360deg);} }
.spinner { width:44px; height:44px; border-radius:50%; border:4px solid rgba(255,255,255,0.12); border-top-color:var(--neon-green); animation:spin 0.9s linear infinite; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="application" aria-label="ASTRONBOT.MAX final clone">
      <header>
        <div class="left-header">
          <div class="logo-mark" aria-hidden="true"></div>
          <div class="brand">
            <div class="brand-top">
              <div class="brand-text">ASTRONBOT.MAX</div>
            </div>
            <div class="subtitle">TRADING A.I.</div>
          </div>
        </div>

        <div class="controls" aria-hidden="false">
          <div class="select" id="pairSelect" tabindex="0" aria-haspopup="listbox" aria-expanded="false" role="button" aria-label="Choose pair">
            <div class="label">PAIR</div>
            <div class="value" id="pairValue">NZDCAD</div>
          </div>

          <div class="select" id="tfSelect" tabindex="0" aria-haspopup="listbox" aria-expanded="false" role="button" aria-label="Choose timeframe">
            <div class="label">TIMEFRAME</div>
            <div class="value" id="tfValue">M1</div>
          </div>
        </div>
      </header>

      <main>
        <div class="main-inner">
          <!-- background -->
          <div class="bg-wrap" aria-hidden="true">
            <canvas id="algoCanvas"></canvas>
            <div class="bg-overlay" aria-hidden="true"></div>

            <!-- bokeh -->
            <div id="b1" class="bokeh" style="width:260px;height:260px;background:radial-gradient(circle at center, rgba(200,230,255,0.9), rgba(200,230,255,0.06)); left:6%; top:10%; opacity:0.5;"></div>
            <div id="b2" class="bokeh" style="width:220px;height:220px;background:radial-gradient(circle at center, rgba(220,245,255,0.9), rgba(220,245,255,0.06)); right:8%; top:18%; opacity:0.28;"></div>
            <div id="b3" class="bokeh" style="width:160px;height:160px;background:radial-gradient(circle at center, rgba(200,230,255,0.95), rgba(200,230,255,0.12)); left:42%; bottom:20%; opacity:0.36;"></div>
          </div>

          <!-- dropdowns container -->
          <div id="dropdowns" style="position:absolute; top:84px; right:22px; z-index:200;"></div>

          <div class="center">
            <div class="triangle-area" aria-hidden="false">
              <div class="up-tri" id="upTri">
                <svg viewBox="0 0 100 100" aria-hidden="true">
                  <defs>
                    <filter id="gA"><feGaussianBlur stdDeviation="6" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                    <linearGradient id="upPanel" x1="0" x2="0" y1="0" y2="1">
                      <stop offset="0%" stop-color="rgba(255,255,255,0.06)" />
                      <stop offset="100%" stop-color="rgba(0,0,0,0.18)" />
                    </linearGradient>
                  </defs>
                  <polygon id="upPoly" points="50,6 95,86 5,86" fill="#00d64a" filter="url(#gA)"></polygon>
                  <rect x="18" y="40" width="64" height="26" rx="8" fill="url(#upPanel)"></rect>
                  <text id="upText" x="50" y="53" text-anchor="middle" font-size="16" fill="#fff" style="font-family:Orbitron, sans-serif; pointer-events:none"></text>
                </svg>
              </div>

              <div class="connector" aria-hidden="true"></div>

              <div class="down-tri" id="downTri">
                <svg viewBox="0 0 100 100" aria-hidden="true">
                  <defs>
                    <filter id="gB"><feGaussianBlur stdDeviation="6" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                    <linearGradient id="downPanel" x1="0" x2="0" y1="0" y2="1">
                      <stop offset="0%" stop-color="rgba(255,255,255,0.06)" />
                      <stop offset="100%" stop-color="rgba(0,0,0,0.22)" />
                    </linearGradient>
                  </defs>
                  <polygon id="downPoly" points="50,95 95,15 5,15" fill="#ef4444" filter="url(#gB)"></polygon>
                  <rect x="18" y="42" width="64" height="30" rx="8" fill="url(#downPanel)"></rect>
                  <text id="downText" x="50" y="56" text-anchor="middle" font-size="20" fill="#fff" style="font-family:Orbitron, sans-serif; pointer-events:none"></text>
                </svg>
              </div>

              <div class="down-glow" aria-hidden="true"></div>

              <div class="rec-badge" id="recBadge" aria-hidden="false">
                <div class="rec clickable" id="rec">START</div>
                <div class="small" id="recSmall">Contact support to activate</div>
              </div>
            </div>

            <div class="meta">Percentages estimated by the model — window: <span id="metaTF">M1</span> — <span id="metaTs">Last update: —</span></div>

            <div class="pills" role="toolbar">
              <div class="pill green" id="btnReport">ABRIR RELATÓRIO</div>
              <div class="pill green" id="btnBroker">MUDAR CORRETORA</div>
              <div class="pill green" id="btnDownload">BAIXAR PLANILHA</div>
              <div class="pill green" id="btnTelegram">TELEGRAM SUPPORT</div>
              <div class="pill orange" id="btnLogout">DESLOGAR</div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Premium modal -->
  <div id="premiumModal" style="display:none;" role="dialog" aria-modal="true">
    <div class="modal-backdrop">
      <div class="modal" role="document">
        <h2>Premium required</h2>
        <p><strong>Why this is premium:</strong> The detailed percentage readouts, downloadable reports and broker actions depend on our real-time model and protected reporting — subscribing unlocks real-time percentages, downloads and broker integration.</p>
        <p style="margin-top:6px;color:var(--muted)">Subscribe to unlock:<br>• Real-time confidence percentages<br>• Downloadable reports & sheets<br>• Broker integration and premium alerts</p>
        <div class="actions">
          <button class="btn ghost" id="modalLater">Maybe later</button>
          <button class="btn primary" id="modalSubscribe">Subscribe (demo)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SUPPORT modal -->
  <div id="supportModal" style="display:none;" role="dialog" aria-modal="true">
    <div class="modal-backdrop">
      <div class="modal" role="document">
        <h2>Activation required — Contact Support</h2>
        <p class="support-strong">To start the live signal you must activate your account. Our team verifies each activation to maintain model integrity and high-quality signals.</p>
        <p style="color:var(--muted)">Contact our support team and they will guide you. Activation unlocks START, detailed percentages and premium features.</p>

        <div class="support-contact">
          <a class="btn primary" id="contactSupport" href="mailto:support@astronbot.max?subject=Activation%20Request%20(ASTRONBOT.MAX)">Contact Support</a>
          <a class="btn ghost" id="contactTelegramModal" href="#" target="_blank" rel="noopener">Contact via Telegram</a>
          <button class="btn ghost" id="supportLater">Maybe later</button>
        </div>

        <div style="margin-top:14px;color:var(--muted);font-size:13px">Pro tip: include your account email and preferred pair/timeframe for faster activation.</div>
      </div>
    </div>
  </div>

<script>
/* ====== Script: dropdowns, triangles, background, telegram, custom-add ====== */

let isSubscribed = false;

const pairs = [
  'NZDCAD','EURUSD','GBPUSD','USDJPY','AUDUSD','USDCAD','EURJPY','BTCUSD','ETHUSD','XAUUSD',
  'USDSGD','USDCHF','NZDUSD','CADJPY','AUDJPY' /* additional spare pairs */
];
const timeframes = ['M1','M5','M15','M30','H1','H4','D1','W1','MN']; /* more options */

const pairSelect = document.getElementById('pairSelect');
const tfSelect = document.getElementById('tfSelect');
const pairValue = document.getElementById('pairValue');
const tfValue = document.getElementById('tfValue');
const dropdowns = document.getElementById('dropdowns');

const upText = document.getElementById('upText');
const downText = document.getElementById('downText');
const upTri = document.getElementById('upTri');
const downTri = document.getElementById('downTri');
const recEl = document.getElementById('rec');
const recSmall = document.getElementById('recSmall');
const metaTF = document.getElementById('metaTF');
const metaTs = document.getElementById('metaTs');

const premiumModal = document.getElementById('premiumModal');
const modalSubscribe = document.getElementById('modalSubscribe');
const modalLater = document.getElementById('modalLater');

const supportModal = document.getElementById('supportModal');
const contactSupport = document.getElementById('contactSupport');
const contactTelegramModal = document.getElementById('contactTelegramModal');
const supportLater = document.getElementById('supportLater');

const btnReport = document.getElementById('btnReport');
const btnBroker = document.getElementById('btnBroker');
const btnDownload = document.getElementById('btnDownload');
const btnTelegram = document.getElementById('btnTelegram');
const btnLogout = document.getElementById('btnLogout');

function formatPct(n){
  return Number(n).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2}) + '%';
}

/* triangles */
function setTriangles(up, down){
  up = Math.max(0, Math.min(100, up));
  down = Math.max(0, Math.min(100, down));

  if(isSubscribed){
    upText.textContent = formatPct(up);
    downText.textContent = formatPct(down);
  } else {
    upText.textContent = '';
    downText.textContent = '';
  }

  const minScale = 0.86;
  const maxExtra = 0.36;
  const upScale = minScale + (up/100) * maxExtra;
  const downScale = minScale + (down/100) * maxExtra;

  const upOffsetPx = - Math.min(34, Math.round((up/100)*36));
  const downOffsetPx = Math.min(20, Math.round((down/100)*32));

  upTri.style.transform = `translateX(-50%) translateY(${upOffsetPx}px) scale(${upScale})`;
  downTri.style.transform = `translateX(-50%) translateY(${downOffsetPx}px) scale(${downScale})`;

  if(isSubscribed){
    if(down > up){
      recEl.textContent = 'SELL';
      recEl.style.color = getComputedStyle(document.documentElement).getPropertyValue('--neo-red') || '#e33b3b';
      recEl.classList.remove('clickable');
      recSmall.textContent = 'Confidence';
    } else {
      recEl.textContent = 'BUY';
      recEl.style.color = getComputedStyle(document.documentElement).getPropertyValue('--neon-green') || '#00ff33';
      recEl.classList.remove('clickable');
      recSmall.textContent = 'Confidence';
    }
  } else {
    recEl.textContent = 'START';
    recEl.style.color = getComputedStyle(document.documentElement).getPropertyValue('--neon-green') || '#00ff33';
    recEl.classList.add('clickable');
    recSmall.textContent = 'Contact support to activate';
  }

  metaTs.textContent = 'Last update: ' + new Date().toLocaleTimeString('en-US');
}

setTriangles(16.45, 83.55);

/* Dropdown helpers with "Add custom" support */
function createDropdownShell(){
  const box = document.createElement('div');
  box.className = 'dd-box';
  box.style.position = 'absolute';
  box.style.minWidth = '220px';
  box.style.pointerEvents = 'auto';
  box.style.background = 'linear-gradient(180deg,#071627,#03121a)';
  box.style.border = '1px solid rgba(255,255,255,0.04)';
  box.style.padding = '8px';
  box.style.borderRadius = '10px';
  box.style.boxShadow = '0 10px 40px rgba(0,0,0,0.6)';
  box.style.zIndex = 9999;

  const search = document.createElement('input');
  search.className = 'dd-search';
  search.placeholder = 'Search...';
  search.style.width='100%'; search.style.marginBottom='8px'; search.style.padding='8px'; search.style.borderRadius='8px';
  search.style.border='1px solid rgba(255,255,255,0.03)'; search.style.background='rgba(255,255,255,0.02)'; search.style.color='#eaf6ff';
  box.appendChild(search);

  const list = document.createElement('div');
  list.className = 'dd-list';
  list.style.maxHeight='260px'; list.style.overflow='auto'; list.style.webkitOverflowScrolling='touch';
  box.appendChild(list);

  // area for add custom button when no results
  const addWrap = document.createElement('div');
  addWrap.className = 'dd-add';
  addWrap.style.marginTop = '6px';
  box.appendChild(addWrap);

  box.close = ()=> { if(box.parentNode) box.parentNode.removeChild(box); };
  return box;
}

function buildDropdownContents(box, items, onSelect){
  if(!box) return;
  const search = box.querySelector('.dd-search');
  const list = box.querySelector('.dd-list');
  const addWrap = box.querySelector('.dd-add');
  if(!search || !list) return;
  list.innerHTML = ''; addWrap.innerHTML = '';

  function renderList(filter=''){
    list.innerHTML = '';
    const q = filter.trim().toLowerCase();
    const filtered = items.filter(it => it.toLowerCase().includes(q));
    filtered.forEach(it => {
      const item = document.createElement('div');
      item.className = 'dd-item';
      item.tabIndex = 0;
      item.textContent = it;
      item.style.padding = '8px 10px';
      item.style.borderRadius = '8px';
      item.style.marginBottom = '6px';
      item.style.color = '#e6eef6';
      item.style.cursor = 'pointer';
      item.addEventListener('click', ()=> onSelect(it));
      item.addEventListener('keydown', (e)=> { if(e.key==='Enter') onSelect(it); });
      list.appendChild(item);
    });
    if(filtered.length === 0 && q !== ''){
      const addBtn = document.createElement('div');
      addBtn.textContent = `Add "${filter}" as custom`;
      addBtn.style.padding = '8px';
      addBtn.style.borderRadius = '8px';
      addBtn.style.background = 'rgba(255,255,255,0.02)';
      addBtn.style.cursor = 'pointer';
      addBtn.style.color = '#eaf6ff';
      addBtn.addEventListener('click', ()=>{
        // add to items array (persist for this session)
        items.unshift(filter.toUpperCase());
        onSelect(filter.toUpperCase());
        box.close();
      });
      addWrap.appendChild(addBtn);
    } else {
      addWrap.innerHTML = '';
    }
    list.querySelector('.dd-item')?.focus();
  }

  search.addEventListener('input', ()=> renderList(search.value));
  renderList('');
}

/* open position under clicked control precisely */
function openPairsDropdown(){
  dropdowns.innerHTML = '';
  const box = createDropdownShell();
  buildDropdownContents(box, pairs, selectedPair);
  const rect = pairSelect.getBoundingClientRect();
  const cardRect = document.querySelector('.card').getBoundingClientRect();
  box.style.left = Math.round(rect.left - cardRect.left) + 'px';
  box.style.top  = Math.round(rect.bottom - cardRect.top + 8) + 'px';
  dropdowns.appendChild(box);
  pairSelect.setAttribute('aria-expanded','true');
}

function openTFDropdown(){
  dropdowns.innerHTML = '';
  const box = createDropdownShell();
  buildDropdownContents(box, timeframes, selectedTF);
  const rect = tfSelect.getBoundingClientRect();
  const cardRect = document.querySelector('.card').getBoundingClientRect();
  box.style.left = Math.round(rect.left - cardRect.left) + 'px';
  box.style.top  = Math.round(rect.bottom - cardRect.top + 8) + 'px';
  dropdowns.appendChild(box);
  tfSelect.setAttribute('aria-expanded','true');
}

pairSelect.addEventListener('click', openPairsDropdown);
tfSelect.addEventListener('click', openTFDropdown);

/* close dropdowns on outside click / ESC */
document.addEventListener('click', (e)=>{
  const inside = e.target.closest('.select') || e.target.closest('#dropdowns') || e.target.closest('.dd-box');
  if(!inside){
    dropdowns.innerHTML = '';
    pairSelect.setAttribute('aria-expanded','false');
    tfSelect.setAttribute('aria-expanded','false');
  }
});
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ dropdowns.innerHTML=''; pairSelect.setAttribute('aria-expanded','false'); tfSelect.setAttribute('aria-expanded','false'); hidePremiumModal(); hideSupportModal(); } });

/* selection handlers */
function selectedPair(val){
  pairValue.textContent = val;
  dropdowns.innerHTML = '';
  pairSelect.setAttribute('aria-expanded','false');
  const up = +(Math.random()*70 + 8).toFixed(2);
  setTriangles(up, +(100-up).toFixed(2));
  metaTF.textContent = tfValue.textContent;
  if(window.onPairTimeframeUpdate) window.onPairTimeframeUpdate({pair:val, timeframe:tfValue.textContent, up, down:100-up});
}
function selectedTF(val){
  tfValue.textContent = val;
  dropdowns.innerHTML = '';
  tfSelect.setAttribute('aria-expanded','false');
  const up = +(Math.random()*70 + 8).toFixed(2);
  setTriangles(up, +(100-up).toFixed(2));
  metaTF.textContent = val;
  if(window.onPairTimeframeUpdate) window.onPairTimeframeUpdate({pair:pairValue.textContent, timeframe:val, up, down:100-up});
}

/* Background: neon white numbers on blue/white wash */
(function backgroundCanvas(){
  const canvas = document.getElementById('algoCanvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d', { alpha:true });
  let w=0,h=0, cols=0, colW=14, drops=[];

  const small = ()=> window.matchMedia('(max-width:560px)').matches;

  function resize(){
    const rect = canvas.getBoundingClientRect();
    w = Math.max(480, Math.floor(rect.width));
    h = Math.max(320, Math.floor(rect.height));
    canvas.width = Math.floor(w * devicePixelRatio);
    canvas.height = Math.floor(h * devicePixelRatio);
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    colW = small() ? 18 : 14;
    cols = Math.floor(w / colW);
    drops = Array.from({length:cols}, ()=> Math.random() * h * -1);
  }
  resize();
  window.addEventListener('resize', resize);

  const glyphs = '0123456789';
  let raf;

  function frame(now){
    // bluish wash base
    ctx.clearRect(0,0,w,h);
    // soft radial background
    const g = ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0, 'rgba(50,120,190,0.12)');
    g.addColorStop(1, 'rgba(10,30,60,0.48)');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    // faint cloud blur shapes for white/blue floaters
    for(let i=0;i<3;i++){
      const gx = ctx.createRadialGradient(w* (0.15 + i*0.28), h* (0.2 + i*0.25), 40, w* (0.15 + i*0.28), h* (0.2 + i*0.25), 220);
      gx.addColorStop(0, `rgba(220,240,255,${0.06 + i*0.02})`);
      gx.addColorStop(1, 'rgba(30,40,70,0)');
      ctx.fillStyle = gx;
      ctx.fillRect(0,0,w,h);
    }

    // vertical soft streaks
    for(let i=0;i<4;i++){
      ctx.globalAlpha = 0.02 + i*0.01;
      ctx.fillStyle = `rgba(255,255,255,${0.005 + i*0.01})`;
      const x = (i / 4) * w + (Math.sin(now/800 + i) * 20);
      ctx.fillRect(x, 0, Math.max(30, w/16), h);
    }
    ctx.globalAlpha = 1;

    // draw numeric columns with white/cyan heads
    ctx.textAlign = 'center';

    for(let i=0;i<cols;i++){
      const x = i*colW + (Math.random()*4 - 2);
      let y = drops[i];
      // draw 2-3 layered glyphs to create glow feeling (will be blurred by CSS filter)
      const size = small() ? 12 : 18;
      ctx.font = `${size}px monospace`;
      // faint trailing
      ctx.fillStyle = 'rgba(255,255,255,0.06)';
      for(let t=0;t<3;t++){
        ctx.fillText(glyphs.charAt(Math.floor(Math.random()*glyphs.length)), x, y - t*12);
      }
      // main head (white with slight cyan stroke)
      ctx.fillStyle = 'rgba(255,255,255,0.9)';
      ctx.fillText(glyphs.charAt(Math.floor(Math.random()*glyphs.length)), x, y);
      // cyan glow stroke (subtle)
      ctx.strokeStyle = 'rgba(160,230,255,0.18)';
      ctx.lineWidth = 1;
      ctx.strokeText(glyphs.charAt(Math.floor(Math.random()*glyphs.length)), x, y);

      drops[i] = y + (2 + Math.random()*6) * (small()? 0.6:1.0);
      if(drops[i] > h + 80) drops[i] = Math.random()*-150;
    }

    raf = requestAnimationFrame(frame);
  }

  raf = requestAnimationFrame(frame);

  // gentle bokeh motion
  const b1 = document.getElementById('b1'), b2 = document.getElementById('b2'), b3 = document.getElementById('b3');
  let t=0;
  function bokehLoop(){
    t += 0.009;
    if(b1){ b1.style.left = (6 + Math.sin(t*0.9)*1.6) + '%'; b1.style.top = (10 + Math.cos(t*0.7)*1.8) + '%'; }
    if(b2){ b2.style.right = (8 + Math.cos(t*0.6)*1.6) + '%'; b2.style.top = (18 + Math.sin(t*0.5)*1.6) + '%'; }
    if(b3){ b3.style.left = (42 + Math.sin(t*0.4)*2.3) + '%'; b3.style.bottom = (20 + Math.cos(t*0.8)*1.6) + '%'; }
    requestAnimationFrame(bokehLoop);
  }
  bokehLoop();

})();

/* Modals and flows */
function showPremiumModal(){ premiumModal.style.display = 'block'; document.body.style.overflow = 'hidden'; }
function hidePremiumModal(){ premiumModal.style.display = 'none'; document.body.style.overflow = ''; }
modalLater?.addEventListener('click', ()=> hidePremiumModal());
modalSubscribe?.addEventListener('click', ()=> { isSubscribed = true; hidePremiumModal(); setTriangles( +(Math.random()*70 + 8).toFixed(2), +(100 - (Math.random()*70 + 8)).toFixed(2) ); });

function buildPrefillMessage(){
  const pair = pairValue?.textContent || '—';
  const tf   = tfValue?.textContent || '—';
  return `Activation / Balance Request (ASTRONBOT.MAX)\nPair: ${pair}\nTimeframe: ${tf}\nPlease verify activation and account balance. Account email: [your email here]`;
}
function buildTelegramShareURL(message){
  const base = 'https://t.me/share/url';
  const params = new URLSearchParams({ url:'', text: message });
  return base + '?' + params.toString();
}

function showSupportModal(){
  contactTelegramModal.href = buildTelegramShareURL(buildPrefillMessage());
  supportModal.style.display = 'block';
  document.body.style.overflow = 'hidden';
}
function hideSupportModal(){ supportModal.style.display = 'none'; document.body.style.overflow = ''; }
supportLater?.addEventListener('click', ()=> hideSupportModal());

recEl?.addEventListener('click', (e)=>{
  if(!isSubscribed){
    showSupportModal();
    e.preventDefault();
    return;
  }
});

/* Telegram button behavior */
btnTelegram?.addEventListener('click', ()=>{
  const url = buildTelegramShareURL(buildPrefillMessage());
  window.open(url, '_blank', 'noopener');
});

/* Block action buttons if not subscribed */
[btnReport, btnBroker, btnDownload, btnLogout].forEach(btn => {
  btn.addEventListener('click', (e)=>{
    if(!isSubscribed){
      showPremiumModal();
      e.preventDefault();
      return;
    }
    if(btn === btnDownload){
      const csv = 'pair,timeframe,up,down\n' + pairValue.textContent + ',' + tfValue.textContent + ',' + (upText.textContent || '') + ',' + (downText.textContent || '');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='sheet.csv'; document.body.appendChild(a); a.click(); a.remove();
    } else {
      alert('Feature: ' + btn.textContent + ' (real app should implement).');
    }
  });
});

/* keyboard open */
pairSelect.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); openPairsDropdown(); }});
tfSelect.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); openTFDropdown(); }});

/* backend hook */
window.onPairTimeframeUpdate = window.onPairTimeframeUpdate || null;
window.feedLive = function(msg){
  if(!msg || typeof msg.up !== 'number') return;
  setTriangles(msg.up, msg.down);
};
</script>
</body>
</html>
