<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ASTRONBOT.MAX — Deep Clone (finalized)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --neon-green:#00ff33;
  --neon-green-2:#17d24a;
  --neo-red:#e33b3b;
  --muted:#cbd5e1;
  --glass: rgba(255,255,255,0.04);
  --max-width:1100px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#000;color:#eaf6ff}
.wrap{ min-height:100vh; display:flex; align-items:center; justify-content:center; padding:18px; }
.card{ width:100%; max-width:var(--max-width); border-radius:14px; overflow:visible; position:relative; background:linear-gradient(180deg, rgba(1,6,10,0.9), rgba(2,8,12,0.98)); border:1px solid var(--glass); box-shadow:0 18px 60px rgba(0,0,0,0.75); }

/* header tuned (explicit px values) */
header{ display:flex; justify-content:space-between; align-items:center; padding:12px 18px 22px; z-index:60; position:relative; background:linear-gradient(180deg, rgba(2,6,10,0.85), rgba(2,6,10,0.5)); height:88px; }
.left-header{display:flex; align-items:center; gap:12px; min-width:0;}
.logo-mark{width:48px;height:48px; background:linear-gradient(180deg,var(--neon-green),var(--neon-green-2)); clip-path:polygon(50% 0%,100% 100%,0% 100%); box-shadow:0 0 22px rgba(0,255,51,0.95);}
.brand{display:flex;flex-direction:column;min-width:0;}
.brand-top{display:flex;align-items:center;gap:12px}
.brand-text{ font-family:Orbitron, sans-serif; color:var(--neon-green); font-weight:900; font-size:40px; line-height:40px; letter-spacing:1px; text-transform:uppercase; text-shadow:0 0 12px rgba(0,255,51,0.92),0 12px 36px rgba(0,0,0,0.6); }
.subtitle{ font-family:Orbitron, sans-serif; font-size:12px; color:var(--neon-green-2); letter-spacing:2px; margin-left:2px; font-weight:800; text-transform:uppercase; text-shadow:0 0 8px rgba(0,255,51,0.18); }

/* Controls spacing & position */
.controls { display:flex; gap:28px; align-items:center; z-index:70; position:absolute; right:18px; top:110px; pointer-events:auto; }

/* select chips */
.select{ background:linear-gradient(180deg,#132733,#0e1a28); padding:10px 14px; border-radius:10px; border:1px solid var(--glass); min-width:160px; color:#e8fbff; cursor:pointer; -webkit-tap-highlight-color: transparent; box-shadow: inset 0 -6px 14px rgba(0,0,0,0.3); }
.select .label{font-size:11px;color:var(--muted); display:block; margin-bottom:2px}
.select .value{font-weight:800; font-size:14px}

/* main content */
main{position:relative; padding:14px 18px 28px;}
.main-inner{ position:relative; border-radius:12px; overflow:hidden; background:linear-gradient(180deg, rgba(0,0,0,0.36), rgba(0,0,0,0.45)); min-height:760px; }

/* background: two canvas layers */
.bg-wrap{ position:absolute; inset:0; z-index:0; overflow:hidden; }
#washCanvas{ position:absolute; top:0; left:0; width:100%; height:100%; display:block; filter: saturate(118%); transform:scale(1.02); }
#numsCanvas{ position:absolute; top:0; left:0; width:100%; height:100%; display:block; filter: blur(10px) contrast(125%) brightness(115%); transform:scale(1.03); mix-blend-mode:screen; opacity:0.95; }
.bg-overlay{ position:absolute; inset:0; z-index:1; pointer-events:none; background:linear-gradient(180deg, rgba(6,30,60,0.08), rgba(3,8,18,0.6)); }

/* bokeh glows */
.bokeh { position:absolute; border-radius:50%; filter: blur(18px) saturate(160%); opacity:0.75; mix-blend-mode:screen; z-index:0; pointer-events:none; }

/* center above background */
.center{ position:relative; z-index:12; display:flex; align-items:center; flex-direction:column; gap:18px; padding:32px 10px; }

/* triangle area tuned */
.triangle-area{ width:100%; max-width:680px; height:460px; display:flex; align-items:center; justify-content:center; position:relative; }
.up-tri, .down-tri { position:absolute; left:50%; transform-origin:center; transition: transform .36s cubic-bezier(.22,.98,.33,1), opacity .25s ease; }
.up-tri{ top:120px; transform:translateX(-50%) scale(1); z-index:8; }
.up-tri svg{ width:220px; height:220px; display:block; }
.connector { position:absolute; top:256px; left:50%; transform:translate(-50%,-2px); width:260px; height:6px; border-radius:6px; z-index:6; background:linear-gradient(90deg, rgba(0,255,51,0.12), rgba(255,255,255,0.03), rgba(227,59,59,0.06)); box-shadow:0 10px 30px rgba(0,0,0,0.6); }
.down-tri{ top:260px; transform:translateX(-50%) scale(1.08); z-index:10; }
.down-tri svg{ width:320px; height:320px; display:block; }
.down-glow{ position:absolute; width:96px;height:52px;border-radius:50%; background:radial-gradient(circle at center, rgba(0,255,51,0.98) 0%, rgba(0,255,51,0.28) 25%, rgba(0,0,0,0) 65%); bottom:34px; left:50%; transform:translateX(-50%); filter:blur(6px); z-index:7; }

/* svg text */
svg text{ font-family:Orbitron, monospace; font-weight:900; fill:#ffffff; paint-order:stroke fill; stroke: rgba(0,0,0,0.65); stroke-width:2px; filter: drop-shadow(0 6px 8px rgba(0,0,0,0.55)); dominant-baseline:middle; letter-spacing:0.6px; }

/* rec badge */
.rec-badge{ position:absolute; left:22px; bottom:26px; z-index:14; background:linear-gradient(180deg, rgba(3,6,10,0.72), rgba(7,9,12,0.6)); padding:8px 14px; border-radius:999px; border:1px solid rgba(255,255,255,0.04); display:flex; gap:8px; align-items:center; }
.rec-badge .rec{ padding:8px 12px; border-radius:8px; font-weight:900; text-transform:uppercase; font-family:Orbitron, sans-serif; color:var(--neon-green); background:transparent; cursor:pointer; transition:transform .12s ease, box-shadow .12s ease; }
.rec-badge .rec.clickable{ background:linear-gradient(180deg,var(--neon-green-2),var(--neon-green)); color:#071012; box-shadow:0 10px 30px rgba(0,255,51,0.18); }
.rec-badge .rec:active{ transform:translateY(1px) }
.rec-badge .small{ font-size:12px; color:var(--muted); }

/* pills */
.pills{ margin-top:18px; display:flex; flex-direction:column; gap:14px; align-items:center; z-index:14; }
.pill{ width:240px; padding:12px; border-radius:26px; font-weight:800; font-size:13px; text-transform:uppercase; cursor:pointer; border:1px solid rgba(255,255,255,0.04); box-shadow:0 10px 30px rgba(0,0,0,0.5); text-align:center; }
.pill.green{ background:linear-gradient(180deg,var(--neon-green-2),var(--neon-green)); color:#071012; }
.pill.orange{ background:linear-gradient(180deg,#fbbf24,#f59e0b); color:#071012; width:160px; }

/* modal */
.modal-backdrop{ position:fixed; inset:0; z-index:1200; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); }
.modal{ width:92%; max-width:520px; background:linear-gradient(180deg,#081018,#061016); border-radius:12px; padding:20px; box-shadow:0 24px 80px rgba(0,0,0,0.8); border:1px solid rgba(255,255,255,0.03); color:#eaf6ff; }
.modal h2{ margin:0 0 8px 0; font-family:Orbitron, sans-serif; color:var(--neon-green); letter-spacing:1px; font-size:20px; }
.modal p{ color:var(--muted); margin:0 0 12px 0; line-height:1.35; }
.modal .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
.btn{ padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer; border:0; }
.btn.ghost{ background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.04); }
.btn.primary{ background:linear-gradient(180deg,var(--neon-green-2),var(--neon-green)); color:#071012; }

/* meta */
.meta{ font-size:13px; color:var(--muted); margin-top:8px; }

/* responsive */
@media (max-width:760px){
  .wrap{ padding:0; }
  .card{ border-radius:0; max-width:100%; min-height:100vh; box-shadow:none; }
  header{ padding:10px 12px 18px; height:84px; }
  .controls{ right:12px; top:140px; gap:14px; }
  .main-inner{ min-height:calc(100vh - 140px); }
  .up-tri{ top:92px; }
  .down-tri{ top:210px; transform:translateX(-50%) scale(0.95); }
}

/* spinner */
@keyframes spin { to { transform: rotate(360deg);} }
.spinner { width:44px; height:44px; border-radius:50%; border:4px solid rgba(255,255,255,0.12); border-top-color:var(--neon-green); animation:spin 0.9s linear infinite; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="application" aria-label="ASTRONBOT.MAX final clone">
      <header>
        <div class="left-header">
          <div class="logo-mark" aria-hidden="true"></div>
          <div class="brand">
            <div class="brand-top">
              <div class="brand-text">ASTRONBOT.MAX</div>
            </div>
            <div class="subtitle">TRADING A.I.</div>
          </div>
        </div>

        <div class="controls" aria-hidden="false">
          <div class="select" id="pairSelect" tabindex="0" aria-haspopup="listbox" aria-expanded="false" role="button" aria-label="Choose pair">
            <div class="label">PAIR</div>
            <div class="value" id="pairValue">NZDCAD</div>
          </div>

          <div class="select" id="tfSelect" tabindex="0" aria-haspopup="listbox" aria-expanded="false" role="button" aria-label="Choose timeframe">
            <div class="label">TIMEFRAME</div>
            <div class="value" id="tfValue">M1</div>
          </div>
        </div>
      </header>

      <main>
        <div class="main-inner">
          <!-- background -->
          <div class="bg-wrap" aria-hidden="true">
            <canvas id="washCanvas"></canvas>
            <canvas id="numsCanvas"></canvas>
            <div class="bg-overlay" aria-hidden="true"></div>

            <div id="b1" class="bokeh" style="width:260px;height:260px;background:radial-gradient(circle at center, rgba(180,235,255,0.95), rgba(180,235,255,0.04)); left:6%; top:10%; opacity:0.48;"></div>
            <div id="b2" class="bokeh" style="width:220px;height:220px;background:radial-gradient(circle at center, rgba(210,245,255,0.95), rgba(210,245,255,0.04)); right:8%; top:18%; opacity:0.26;"></div>
            <div id="b3" class="bokeh" style="width:160px;height:160px;background:radial-gradient(circle at center, rgba(200,230,255,0.95), rgba(200,230,255,0.06)); left:42%; bottom:20%; opacity:0.34;"></div>
          </div>

          <div id="dropdowns" style="position:absolute; top:84px; right:22px; z-index:200;"></div>

          <div class="center">
            <div class="triangle-area" aria-hidden="false">
              <div class="up-tri" id="upTri">
                <svg viewBox="0 0 100 100" aria-hidden="true">
                  <defs>
                    <filter id="gA"><feGaussianBlur stdDeviation="6" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                    <linearGradient id="upPanel" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="rgba(255,255,255,0.06)" /><stop offset="100%" stop-color="rgba(0,0,0,0.18)" /></linearGradient>
                  </defs>
                  <polygon id="upPoly" points="50,6 95,86 5,86" fill="#00d64a" filter="url(#gA)"></polygon>
                  <rect x="18" y="40" width="64" height="26" rx="8" fill="url(#upPanel)"></rect>
                  <text id="upText" x="50" y="53" text-anchor="middle" font-size="16" fill="#fff" style="font-family:Orbitron, sans-serif; pointer-events:none"></text>
                </svg>
              </div>

              <div class="connector" aria-hidden="true"></div>

              <div class="down-tri" id="downTri">
                <svg viewBox="0 0 100 100" aria-hidden="true">
                  <defs>
                    <filter id="gB"><feGaussianBlur stdDeviation="6" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                    <linearGradient id="downPanel" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="rgba(255,255,255,0.06)" /><stop offset="100%" stop-color="rgba(0,0,0,0.22)" /></linearGradient>
                  </defs>
                  <polygon id="downPoly" points="50,95 95,15 5,15" fill="#ef4444" filter="url(#gB)"></polygon>
                  <rect x="18" y="42" width="64" height="30" rx="8" fill="url(#downPanel)"></rect>
                  <text id="downText" x="50" y="56" text-anchor="middle" font-size="20" fill="#fff" style="font-family:Orbitron, sans-serif; pointer-events:none"></text>
                </svg>
              </div>

              <div class="down-glow" aria-hidden="true"></div>

              <div class="rec-badge" id="recBadge" aria-hidden="false">
                <div class="rec clickable" id="rec">START</div>
                <div class="small" id="recSmall">Contact support to activate</div>
              </div>
            </div>

            <div class="meta">Percentages estimated by the model — window: <span id="metaTF">M1</span> — <span id="metaTs" aria-live="polite">Last update: —</span></div>

            <div class="pills" role="toolbar">
              <div class="pill green" id="btnReport">OPEN REPORT</div>
              <div class="pill green" id="btnBroker">CHANGE BROKER</div>
              <div class="pill green" id="btnDownload">DOWNLOAD SHEET</div>
              <div class="pill green" id="btnTelegram">TELEGRAM SUPPORT</div>
              <div class="pill orange" id="btnLogout">LOGOUT</div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Premium modal -->
  <div id="premiumModal" style="display:none;" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-backdrop">
      <div class="modal" role="document" aria-labelledby="premiumTitle">
        <h2 id="premiumTitle">Premium required</h2>
        <p id="premiumCopy"><strong>Why this is premium:</strong> Detailed percentage readouts, downloadable reports and broker integration depend on our real-time model and protected reporting. Subscribing keeps signal integrity and gives priority access to sharp signals.</p>
        <p style="margin-top:6px;color:var(--muted)">Subscribe to unlock:<br>• Real-time confidence percentages<br>• Downloadable reports & sheets<br>• Broker integration and priority alerts</p>
        <div class="actions">
          <button class="btn ghost" id="modalLater">Maybe later</button>
          <button class="btn primary" id="modalSubscribe">Subscribe (demo)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Support modal -->
  <div id="supportModal" style="display:none;" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-backdrop">
      <div class="modal" role="document" aria-labelledby="supportTitle">
        <h2 id="supportTitle">Activation required — Contact Support</h2>
        <p class="support-strong">To start the live signal you must activate your account. Our team verifies activations to preserve high-quality signals and reduce abuse.</p>
        <p style="color:var(--muted)">Contact support and provide your account email, preferred pair and timeframe. Activation typically completes fast once verified.</p>
        <div class="support-contact" style="display:flex;gap:12px;align-items:center;margin-top:12px">
          <a class="btn primary" id="contactSupport" href="mailto:support@astronbot.max?subject=Activation%20Request%20(ASTRONBOT.MAX)">Contact Support</a>
          <a class="btn ghost" id="contactTelegramModal" href="#" target="_blank" rel="noopener">Contact via Telegram</a>
          <button class="btn ghost" id="supportLater">Maybe later</button>
        </div>
        <div style="margin-top:14px;color:var(--muted);font-size:13px">Pro tip: include your account email and preferred pair/timeframe for faster activation.</div>
      </div>
    </div>
  </div>

<script>
/* Finalized script with background balanced and integrated */

/* state */
let isSubscribed = false;

/* options */
const pairs = ['NZDCAD','EURUSD','GBPUSD','USDJPY','AUDUSD','USDCAD','EURJPY','BTCUSD','ETHUSD','XAUUSD','USDSGD','USDCHF','NZDUSD','CADJPY','AUDJPY'];
const timeframes = ['M1','M5','M15','M30','H1','H4','D1','W1','MN'];

/* DOM refs */
const pairSelect = document.getElementById('pairSelect');
const tfSelect = document.getElementById('tfSelect');
const pairValue = document.getElementById('pairValue');
const tfValue = document.getElementById('tfValue');
const dropdowns = document.getElementById('dropdowns');

const upText = document.getElementById('upText');
const downText = document.getElementById('downText');
const upTri = document.getElementById('upTri');
const downTri = document.getElementById('downTri');
const recEl = document.getElementById('rec');
const recSmall = document.getElementById('recSmall');
const metaTF = document.getElementById('metaTF');
const metaTs = document.getElementById('metaTs');

const premiumModal = document.getElementById('premiumModal');
const premiumTitle = document.getElementById('premiumTitle');
const premiumCopy = document.getElementById('premiumCopy');
const modalSubscribe = document.getElementById('modalSubscribe');
const modalLater = document.getElementById('modalLater');

const supportModal = document.getElementById('supportModal');
const contactSupport = document.getElementById('contactSupport');
const contactTelegramModal = document.getElementById('contactTelegramModal');
const supportLater = document.getElementById('supportLater');

const btnReport = document.getElementById('btnReport');
const btnBroker = document.getElementById('btnBroker');
const btnDownload = document.getElementById('btnDownload');
const btnTelegram = document.getElementById('btnTelegram');
const btnLogout = document.getElementById('btnLogout');

/* utils */
function formatPct(n){ return Number(n).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2}) + '%'; }

/* triangles */
function setTriangles(up, down){
  up = Math.max(0, Math.min(100, up));
  down = Math.max(0, Math.min(100, down));
  if(isSubscribed){ upText.textContent = formatPct(up); downText.textContent = formatPct(down); } else { upText.textContent=''; downText.textContent=''; }

  const minScale = 0.86, maxExtra=0.36;
  const upScale = (minScale + (up/100)*maxExtra).toFixed(4);
  const downScale = (minScale + (down/100)*maxExtra).toFixed(4);
  const upOffsetPx = - Math.min(34, Math.round((up/100)*36));
  const downOffsetPx = Math.min(20, Math.round((down/100)*32));
  upTri.style.transform = `translateX(-50%) translateY(${upOffsetPx}px) scale(${upScale})`;
  downTri.style.transform = `translateX(-50%) translateY(${downOffsetPx}px) scale(${downScale})`;

  if(isSubscribed){
    if(down>up){ recEl.textContent='SELL'; recEl.style.color=getComputedStyle(document.documentElement).getPropertyValue('--neo-red')||'#e33b3b'; recEl.classList.remove('clickable'); recSmall.textContent='Confidence'; }
    else { recEl.textContent='BUY'; recEl.style.color=getComputedStyle(document.documentElement).getPropertyValue('--neon-green')||'#00ff33'; recEl.classList.remove('clickable'); recSmall.textContent='Confidence'; }
  } else {
    recEl.textContent='START'; recEl.style.color=getComputedStyle(document.documentElement).getPropertyValue('--neon-green')||'#00ff33'; recEl.classList.add('clickable'); recSmall.textContent='Contact support to activate';
  }
  metaTs.textContent = 'Last update: ' + new Date().toLocaleTimeString('en-US');
}
setTriangles(16.45,83.55);

/* Dropdowns: accessible listbox with search, arrow nav, enter, escape, custom add */
function createDropdownShell(){
  const box = document.createElement('div');
  box.className='dd-box';
  box.style.position='absolute';
  box.style.minWidth='220px';
  box.style.pointerEvents='auto';
  box.style.background='linear-gradient(180deg,#071627,#03121a)';
  box.style.border='1px solid rgba(255,255,255,0.04)';
  box.style.padding='8px';
  box.style.borderRadius='10px';
  box.style.boxShadow='0 10px 40px rgba(0,0,0,0.6)';
  box.style.zIndex=9999;
  box.cleanR = null;

  const search = document.createElement('input');
  search.className='dd-search';
  search.placeholder='Search...';
  search.style.width='100%'; search.style.marginBottom='8px'; search.style.padding='8px'; search.style.borderRadius='8px';
  search.style.border='1px solid rgba(255,255,255,0.03)'; search.style.background='rgba(255,255,255,0.02)'; search.style.color='#eaf6ff';
  search.setAttribute('aria-label','Filter options');
  box.appendChild(search);

  const list = document.createElement('div');
  list.className='dd-list';
  list.setAttribute('role','listbox');
  list.style.maxHeight='260px'; list.style.overflow='auto'; list.style.webkitOverflowScrolling='touch';
  box.appendChild(list);

  box.close = ()=> { if(box.parentNode) box.parentNode.removeChild(box); if(typeof box.cleanR === 'function') box.cleanR(); };
  return box;
}

function buildDropdownContents(box, items, onSelect){
  if(!box) return;
  const search = box.querySelector('.dd-search');
  const list = box.querySelector('.dd-list');

  let currentIndex = 0;
  function render(filter=''){
    list.innerHTML = '';
    const q = String(filter || '').trim().toLowerCase();
    const filtered = items.filter(it => it.toLowerCase().includes(q));
    filtered.forEach((it, idx)=>{
      const item = document.createElement('div');
      item.className='dd-item';
      item.setAttribute('role','option');
      item.setAttribute('aria-selected','false');
      item.tabIndex=0;
      item.textContent = it;
      item.style.padding='8px 10px'; item.style.borderRadius='8px'; item.style.marginBottom='6px'; item.style.color='#e6eef6'; item.style.cursor='pointer';
      item.addEventListener('click', ()=> { onSelect(it); box.close(); });
      item.addEventListener('keydown', e=> { if(e.key==='Enter'){ onSelect(it); box.close(); }});
      list.appendChild(item);
    });

    if(filtered.length===0 && q!==''){
      const add = document.createElement('div');
      add.textContent = `Add "${filter}"`;
      add.style.padding='8px'; add.style.borderRadius='8px'; add.style.background='rgba(255,255,255,0.02)'; add.style.cursor='pointer'; add.style.color='#eaf6ff';
      add.addEventListener('click', ()=>{
        const k = filter.toUpperCase();
        items.unshift(k);
        onSelect(k);
        box.close();
      });
      list.appendChild(add);
    }
    // set keyboard nav initial
    const first = list.querySelector('[role="option"]');
    if(first) first.focus();
  }

  search.addEventListener('input', ()=> render(search.value));
  // keyboard nav (arrows) on search
  search.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowDown' || e.key==='ArrowUp'){
      e.preventDefault();
      const options = Array.from(list.querySelectorAll('[role="option"]'));
      if(options.length===0) return;
      options[0].focus();
    }
  });

  // arrow nav inside list
  list.addEventListener('keydown', (e)=>{
    const options = Array.from(list.querySelectorAll('[role="option"]'));
    const idx = options.indexOf(document.activeElement);
    if(e.key==='ArrowDown'){ e.preventDefault(); const next = options[Math.min(options.length-1, idx+1)]; if(next) next.focus(); }
    if(e.key==='ArrowUp'){ e.preventDefault(); const prev = options[Math.max(0, idx-1)]; if(prev) prev.focus(); }
    if(e.key==='Escape'){ dropdowns.innerHTML=''; pairSelect.setAttribute('aria-expanded','false'); tfSelect.setAttribute('aria-expanded','false'); }
  });

  render('');
}

/* open Dropdowns under control with autofocus & reposition on scroll/resize */
function openPairsDropdown(){
  dropdowns.innerHTML='';
  const box = createDropdownShell();
  buildDropdownContents(box, pairs, selectedPair);
  const rect = pairSelect.getBoundingClientRect();
  const cardRect = document.querySelector('.card').getBoundingClientRect();
  box.style.left = Math.round(rect.left - cardRect.left) + 'px';
  box.style.top  = Math.round(rect.bottom - cardRect.top + 8) + 'px';
  dropdowns.appendChild(box);
  pairSelect.setAttribute('aria-expanded','true');
  box.querySelector('.dd-search')?.focus();

  function handleScroll(){
    const r = pairSelect.getBoundingClientRect();
    box.style.left = Math.round(r.left - cardRect.left) + 'px';
    box.style.top  = Math.round(r.bottom - cardRect.top + 8) + 'px';
  }
  window.addEventListener('scroll', handleScroll, {passive:true});
  window.addEventListener('resize', handleScroll);
  box.cleanR = ()=>{ window.removeEventListener('scroll', handleScroll); window.removeEventListener('resize', handleScroll); };
}
function openTFDropdown(){
  dropdowns.innerHTML='';
  const box = createDropdownShell();
  buildDropdownContents(box, timeframes, selectedTF);
  const rect = tfSelect.getBoundingClientRect();
  const cardRect = document.querySelector('.card').getBoundingClientRect();
  box.style.left = Math.round(rect.left - cardRect.left) + 'px';
  box.style.top  = Math.round(rect.bottom - cardRect.top + 8) + 'px';
  dropdowns.appendChild(box);
  tfSelect.setAttribute('aria-expanded','true');
  box.querySelector('.dd-search')?.focus();

  function handleScroll(){
    const r = tfSelect.getBoundingClientRect();
    box.style.left = Math.round(r.left - cardRect.left) + 'px';
    box.style.top  = Math.round(r.bottom - cardRect.top + 8) + 'px';
  }
  window.addEventListener('scroll', handleScroll, {passive:true});
  window.addEventListener('resize', handleScroll);
  box.cleanR = ()=>{ window.removeEventListener('scroll', handleScroll); window.removeEventListener('resize', handleScroll); };
}
pairSelect.addEventListener('click', openPairsDropdown);
tfSelect.addEventListener('click', openTFDropdown);

/* close on outside & esc — ensure we call box.close() to cleanup listeners */
document.addEventListener('click', (e)=>{
  const inside = e.target.closest('.select') || e.target.closest('#dropdowns') || e.target.closest('.dd-box');
  if(!inside){
    const box = dropdowns.querySelector('.dd-box');
    if(box && typeof box.close === 'function') box.close();
    dropdowns.innerHTML='';
    pairSelect.setAttribute('aria-expanded','false');
    tfSelect.setAttribute('aria-expanded','false');
  }
});
document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ const box = dropdowns.querySelector('.dd-box'); if(box && typeof box.close === 'function') box.close(); dropdowns.innerHTML=''; pairSelect.setAttribute('aria-expanded','false'); tfSelect.setAttribute('aria-expanded','false'); hidePremiumModal(); hideSupportModal(); } });

/* selection handlers */
function selectedPair(val){
  pairValue.textContent = val;
  const box = dropdowns.querySelector('.dd-box');
  if(box && typeof box.close === 'function') box.close();
  pairSelect.setAttribute('aria-expanded','false');
  const up = +(Math.random()*70 + 8).toFixed(2);
  setTriangles(up, +(100-up).toFixed(2));
  metaTF.textContent = tfValue.textContent;
  if(window.onPairTimeframeUpdate) window.onPairTimeframeUpdate({pair:val, timeframe:tfValue.textContent, up, down:100-up});
}
function selectedTF(val){
  tfValue.textContent = val;
  const box = dropdowns.querySelector('.dd-box');
  if(box && typeof box.close === 'function') box.close();
  tfSelect.setAttribute('aria-expanded','false');
  const up = +(Math.random()*70 + 8).toFixed(2);
  setTriangles(up, +(100-up).toFixed(2));
  metaTF.textContent = val;
  if(window.onPairTimeframeUpdate) window.onPairTimeframeUpdate({pair:pairValue.textContent, timeframe:val, up, down:100-up});
}

/* Balanced Background: dual-canvas (wash + numbers) */
(function dualCanvasBackground(){
  const wash = document.getElementById('washCanvas');
  const nums = document.getElementById('numsCanvas');
  if(!wash || !nums) return;
  const ctxW = wash.getContext('2d');
  const ctxN = nums.getContext('2d');
  if(!ctxW || !ctxN) return;

  const DPR = Math.max(1, window.devicePixelRatio || 1);

  // state
  let w = 0, h = 0;
  let columns = [];
  let rafDraw = null;
  let rafBokeh = null;
  let isRunning = false;
  let t = 0;

  // configure visual params
  const glyphs = '0123456789';
  const MIN_W = 640, MIN_H = 420;

  function makeColumns(width, height){
    const cols = Math.max(28, Math.floor(width / 28));
    columns = Array.from({length: cols}, (_, i) => ({
      x: Math.round((i + 0.5) * (width / cols)),
      y: Math.random() * -height,
      speed: 0.45 + Math.random() * 1.6,
      size: Math.round(40 + Math.random() * 68),
      phase: Math.random() * Math.PI * 2,
      glyphSeed: Math.floor(Math.random() * 10),
      rectOffsetX: (Math.random() - 0.5) * 10,
      rectOffsetY: Math.round(Math.random() * 40) - 20,
      rectW: Math.round(36 + Math.random() * 64),
      rectH: Math.round(28 + Math.random() * 80),
      rectAlpha: 0.055 + Math.random() * 0.11
    }));
  }

  function resize(){
    const rect = wash.getBoundingClientRect();
    w = Math.max(MIN_W, Math.floor(rect.width || MIN_W));
    h = Math.max(MIN_H, Math.floor(rect.height || MIN_H));

    wash.width = Math.floor(w * DPR);
    wash.height = Math.floor(h * DPR);
    nums.width = Math.floor(w * DPR);
    nums.height = Math.floor(h * DPR);

    wash.style.width = w + 'px';
    wash.style.height = h + 'px';
    nums.style.width = w + 'px';
    nums.style.height = h + 'px';

    ctxW.setTransform(1,0,0,1,0,0);
    ctxN.setTransform(1,0,0,1,0,0);
    ctxW.scale(DPR, DPR);
    ctxN.scale(DPR, DPR);

    ctxN.textAlign = 'center';
    ctxN.textBaseline = 'middle';

    makeColumns(w, h);
  }

  function roundRect(ctx, x, y, width, height, r){
    if (r === undefined) r = Math.min(12, Math.min(width, height) * 0.15);
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + width, y, x + width, y + height, r);
    ctx.arcTo(x + width, y + height, x, y + height, r);
    ctx.arcTo(x, y + height, x, y, r);
    ctx.arcTo(x, y, x + width, y, r);
    ctx.closePath();
  }

  function draw(now){
    if (!now) now = performance.now();
    t = now / 1000;

    // WASH LAYER
    ctxW.clearRect(0, 0, w, h);

    const g = ctxW.createLinearGradient(0, 0, 0, h);
    g.addColorStop(0, 'rgba(24,106,165,0.16)');
    g.addColorStop(0.45, 'rgba(10,70,120,0.12)');
    g.addColorStop(1, 'rgba(6,18,36,0.7)');
    ctxW.fillStyle = g;
    ctxW.fillRect(0, 0, w, h);

    // drifting radial glows
    for (let i = 0; i < 3; i++){
      const cx = w * (0.12 + i * 0.33) + Math.sin(now / (600 + i*120)) * w * 0.02;
      const cy = h * (0.18 + i * 0.26) + Math.cos(now / (700 + i*90)) * h * 0.02;
      const r = Math.max(w, h) * (0.4 + i*0.15);
      const rg = ctxW.createRadialGradient(cx, cy, 30, cx, cy, r);
      const alpha = 0.07 + i * 0.02;
      rg.addColorStop(0, `rgba(160,230,255,${alpha})`);
      rg.addColorStop(0.6, `rgba(100,170,210,${alpha*0.36})`);
      rg.addColorStop(1, 'rgba(10,18,28,0)');
      ctxW.globalCompositeOperation = 'lighter';
      ctxW.fillStyle = rg;
      ctxW.fillRect(0, 0, w, h);
      ctxW.globalCompositeOperation = 'source-over';
    }

    // blurred rectangular "blocks"
    for (let i = 0; i < columns.length; i += 3) {
      const c = columns[i];
      const rx = c.x + c.rectOffsetX + Math.sin(now/1200 + c.phase) * 6;
      const ry = ((c.y + c.rectOffsetY) % (h + 200)) - 100;
      const rw = c.rectW;
      const rh = c.rectH;
      ctxW.globalAlpha = c.rectAlpha;
      ctxW.fillStyle = `rgba(200,240,255,1)`;
      roundRect(ctxW, rx - rw*0.5, ry - rh*0.5, rw, rh, Math.min(20, rw*0.2));
      ctxW.fill();
      ctxW.globalAlpha = 1;
    }

    // subtle vertical streaks
    for (let i = 0; i < 6; i++){
      ctxW.globalAlpha = 0.02 + Math.abs(Math.sin(now / 1500 + i * 0.6)) * 0.02;
      ctxW.fillStyle = 'rgba(255,255,255,0.02)';
      const x = (i / 6) * w + Math.sin(now / (500 + i*30)) * 24;
      ctxW.fillRect(x, 0, Math.max(28, w/24), h);
    }
    ctxW.globalAlpha = 1;

    // NUMBERS LAYER
    ctxN.clearRect(0, 0, w, h);
    ctxN.globalCompositeOperation = 'lighter';

    for (let i = 0; i < columns.length; i++){
      const c = columns[i];
      c.y += c.speed + Math.sin((now/800) + c.phase) * 0.6;
      if (c.y > h + c.size) {
        c.y = - (Math.random() * 200 + c.size);
      }
      const glyph = glyphs.charAt((Math.floor(now / 300 + i + c.glyphSeed)) % glyphs.length);
      const x = c.x + Math.sin(now / 1200 + i) * 8;
      const y = c.y;

      ctxN.font = `${Math.round(c.size * 0.72)}px monospace`;
      ctxN.fillStyle = 'rgba(255,255,255,0.06)';
      ctxN.fillText(glyph, x, y);

      ctxN.font = `${c.size}px monospace`;
      ctxN.fillStyle = 'rgba(255,255,255,0.86)';
      ctxN.fillText(glyph, x, y);

      ctxN.lineWidth = Math.max(1, Math.round(c.size * 0.03));
      ctxN.strokeStyle = 'rgba(120,220,255,0.12)';
      ctxN.strokeText(glyph, x, y);
    }

    ctxN.globalCompositeOperation = 'source-over';

    rafDraw = requestAnimationFrame(draw);
  }

  // bokeh micro-motion
  const b1 = document.getElementById('b1'), b2 = document.getElementById('b2'), b3 = document.getElementById('b3');
  let tb = 0;
  function bokehLoop(){
    tb += 0.012;
    if (b1) { b1.style.left = (6 + Math.sin(tb * 0.9) * 1.6) + '%'; b1.style.top = (10 + Math.cos(tb * 0.7) * 1.8) + '%'; }
    if (b2) { b2.style.right = (8 + Math.cos(tb * 0.6) * 1.6) + '%'; b2.style.top = (18 + Math.sin(tb * 0.5) * 1.6) + '%'; }
    if (b3) { b3.style.left = (42 + Math.sin(tb * 0.4) * 2.3) + '%'; b3.style.bottom = (20 + Math.cos(tb * 0.8) * 1.6) + '%'; }
    rafBokeh = requestAnimationFrame(bokehLoop);
  }

  function start(){
    if (isRunning) return;
    isRunning = true;
    resize();
    if(rafDraw) cancelAnimationFrame(rafDraw);
    rafDraw = requestAnimationFrame(draw);
    if(rafBokeh) cancelAnimationFrame(rafBokeh);
    rafBokeh = requestAnimationFrame(bokehLoop);
  }

  function stop(){
    if (!isRunning) return;
    isRunning = false;
    if (rafDraw) { cancelAnimationFrame(rafDraw); rafDraw = null; }
    if (rafBokeh) { cancelAnimationFrame(rafBokeh); rafBokeh = null; }
  }

  function onVisibility(){
    if (document.hidden) stop();
    else start();
  }

  window.addEventListener('resize', () => {
    clearTimeout(window.__astron_resize_timeout);
    window.__astron_resize_timeout = setTimeout(() => { resize(); }, 80);
  }, { passive: true });

  document.addEventListener('visibilitychange', onVisibility);

  window.addEventListener('beforeunload', () => {
    stop();
    document.removeEventListener('visibilitychange', onVisibility);
  });

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(start, 30);
  } else {
    window.addEventListener('load', () => setTimeout(start, 30));
  }
})();

/* Modal helpers with focus trap */
function trapFocus(modalRoot){
  const focusable = modalRoot.querySelectorAll('a[href], button:not([disabled]), input, [tabindex]:not([tabindex="-1"])');
  if(!focusable.length) return ()=>{};
  const first = focusable[0], last = focusable[focusable.length-1];
  first.focus();
  function handleTab(e){
    if(e.key !== 'Tab') return;
    if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
    else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
  }
  document.addEventListener('keydown', handleTab);
  return ()=> document.removeEventListener('keydown', handleTab);
}
let untrap = null, previouslyFocused = null;
function showPremiumModal(){ previouslyFocused = document.activeElement; premiumModal.style.display='block'; premiumModal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; untrap = trapFocus(premiumModal); }
function hidePremiumModal(){ premiumModal.style.display='none'; premiumModal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; if(untrap) untrap(); if(previouslyFocused) previouslyFocused.focus(); }
modalLater?.addEventListener('click', ()=> hidePremiumModal());
modalSubscribe?.addEventListener('click', ()=> { isSubscribed = true; hidePremiumModal(); const up = +(Math.random()*70 + 8).toFixed(2); setTriangles(up, +(100-up).toFixed(2)); });

function showSupportModal(){ previouslyFocused = document.activeElement; contactTelegramModal.href = buildTelegramShareURL(buildPrefillMessage()); supportModal.style.display='block'; supportModal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; untrap = trapFocus(supportModal); }
function hideSupportModal(){ supportModal.style.display='none'; supportModal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; if(untrap) untrap(); if(previouslyFocused) previouslyFocused.focus(); }
supportLater?.addEventListener('click', ()=> hideSupportModal());

/* rec badge */
recEl?.addEventListener('click', (e)=>{
  if(!isSubscribed){ showSupportModal(); e.preventDefault(); return; }
});

/* Telegram helpers */
function buildPrefillMessage(){
  const pair = pairValue?.textContent || '—';
  const tf = tfValue?.textContent || '—';
  return `Activation / Balance Request (ASTRONBOT.MAX)\nPair: ${pair}\nTimeframe: ${tf}\nPlease verify activation and account balance. Account email: [your email here]`;
}
function buildTelegramShareURL(message){
  const base = 'https://t.me/share/url';
  const params = new URLSearchParams({ url:'', text: message });
  return base + '?' + params.toString();
}
btnTelegram?.addEventListener('click', ()=> { window.open(buildTelegramShareURL(buildPrefillMessage()), '_blank', 'noopener'); });

/* tailored premium modal messaging to drive conversions */
function showPremiumModalFor(action){
  const key = String(action || '').toUpperCase();
  if(key.includes('REPORT')) {
    premiumTitle.textContent = 'Reports locked — preview available';
    premiumCopy.innerHTML = '<strong>Unlock detailed reports:</strong> subscribe to download full reports, see historic performance and export CSV. Try a short demo to evaluate the signal quality.';
  } else if(key.includes('BROKER')) {
    premiumTitle.textContent = 'Broker integration';
    premiumCopy.innerHTML = '<strong>Why integrate?</strong> Auto-sync trades, lower latency, and one-click execution with supported brokers. Subscribe to enable broker APIs and priority setup.';
  } else if(key.includes('DOWNLOAD')) {
    premiumTitle.textContent = 'Export access';
    premiumCopy.innerHTML = '<strong>Export & audit-ready sheets:</strong> downloadable reports contain full meta and confidence scores—ideal for audits. Subscribe to enable CSV exports.';
  } else {
    premiumTitle.textContent = 'Premium required';
    premiumCopy.innerHTML = '<strong>Why this is premium:</strong> Detailed readouts and integrations depend on our real-time model. Subscribe to unlock priority signals and export.';
  }
  showPremiumModal();
}

/* buttons: blocked if not subscribed */
[btnReport, btnBroker, btnDownload, btnLogout].forEach(btn => {
  btn.addEventListener('click', (e)=>{
    if(!isSubscribed){
      // tailored persuasion per button
      showPremiumModalFor(btn.textContent.trim());
      e.preventDefault();
      return;
    }
    if(btn===btnDownload){
      const csv = 'pair,timeframe,up,down\n' + pairValue.textContent + ',' + tfValue.textContent + ',' + (upText.textContent || '') + ',' + (downText.textContent || '');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='sheet.csv'; document.body.appendChild(a); a.click(); a.remove();
    } else {
      alert('Feature: ' + btn.textContent + ' (real app should implement).');
    }
  });
});

/* keyboard open for chips */
pairSelect.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); openPairsDropdown(); }});
tfSelect.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); openTFDropdown(); }});

/* integration hook & live feed */
window.onPairTimeframeUpdate = window.onPairTimeframeUpdate || null;
window.feedLive = function(msg){ if(!msg || typeof msg.up !== 'number') return; setTriangles(msg.up, msg.down); };

/* gentle auto updates (visual only) */
let autoUpdate = setInterval(()=>{
  const up = +(Math.random()*70 + 8).toFixed(2);
  setTriangles(up, +(100-up).toFixed(2));
}, 5200);
window.addEventListener('beforeunload', ()=> { clearInterval(autoUpdate); });
</script>
</body>
</html>
